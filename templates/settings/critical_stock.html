{% extends "base.html" %}

{% block title %}Kritik Stok Ayarları - Stok Takip Sistemi{% endblock %}

{% block content %}
<div class="col-12">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center">
            <img src="{{ url_for('static', filename='images/rigel-logo.png') }}" alt="Rigel Logo" height="32" class="me-3">
            <h1 class="h3 mb-0">Kritik Stok Ayarları</h1>
        </div>
        <div class="btn-group" role="group">
            <a href="{{ url_for('main.settings') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Ayarlara Dön
            </a>
            <a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary">
                <i class="bi bi-house"></i> Ana Sayfa
            </a>
        </div>
    </div>

    <!-- Bilgi Kartı -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h5><i class="bi bi-info-circle"></i> Kritik Stok Sınırları Hakkında</h5>
                        <p class="mb-0">Bu sayfada her ürün için kritik stok sınırlarını belirleyebilirsiniz. 
                        Stok seviyesi belirlediğiniz sınırın altına düştüğünde dashboard'da uyarı gösterilir.</p>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <button class="btn btn-outline-primary" onclick="setBulkThreshold()">
                            <i class="bi bi-gear"></i> Toplu Sınır Belirleme
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtreler -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="bi bi-funnel"></i> Filtreler
            </h5>
        </div>
        <div class="card-body">
            <form method="GET" action="{{ url_for('main.settings_critical_stock') }}" id="filterForm">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="search" class="form-label">Ürün Ara</label>
                        <input type="text" class="form-control" id="search" name="search" 
                               value="{{ search }}" placeholder="Ürün kodu veya adı...">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="location" class="form-label">Konum</label>
                        <select class="form-select" id="location" name="location">
                            <option value="">Tüm Konumlar</option>
                            {% for loc in locations %}
                            <option value="{{ loc.konum }}" {% if location == loc.konum %}selected{% endif %}>
                                {{ loc.konum }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="color" class="form-label">Renk</label>
                        <select class="form-select" id="color" name="color">
                            <option value="">Tüm Renkler</option>
                            {% for clr in colors %}
                            <option value="{{ clr.renk }}" {% if color == clr.renk %}selected{% endif %}>
                                {{ clr.renk }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2 mb-3">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-search"></i> Filtrele
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Ürün Listesi -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="bi bi-list-ul"></i> Ürün Listesi ve Kritik Stok Sınırları
            </h5>
            <small class="text-muted">Toplam: {{ total }} ürün</small>
        </div>
        <div class="card-body p-0">
            {% if products %}
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>Ürün Kodu</th>
                            <th>Ürün Adı</th>
                            <th>Renk</th>
                            <th>Konum</th>
                            <th>Mevcut Stok</th>
                            <th>Kritik Sınır</th>
                            <th>Durum</th>
                            <th>İşlemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in products %}
                        <tr {% if product.is_critical %}class="table-warning"{% endif %}>
                            <td>
                                <strong>{{ product.urun_kodu }}</strong>
                            </td>
                            <td>{{ product.urun_adi }}</td>
                            <td>
                                {% if product.renk %}
                                    <span class="badge bg-secondary">{{ product.renk }}</span>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-info">{{ product.konum }}</span>
                            </td>
                            <td>
                                <span class="badge {% if product.is_critical %}bg-danger{% else %}bg-success{% endif %}">
                                    {{ product.adet }} adet
                                </span>
                            </td>
                            <td>
                                <div class="input-group input-group-sm" style="width: 120px;">
                                    <input type="number" class="form-control text-center kritik-sinir-input" 
                                           data-urun-kodu="{{ product.urun_kodu }}" 
                                           data-renk="{{ product.renk or '' }}" 
                                           data-konum="{{ product.konum }}" 
                                           value="{{ product.kritik_stok_siniri or 5 }}"
                                           min="0" max="999" 
                                           title="Kritik stok sınırı">
                                    <button class="btn btn-outline-success btn-sm kritik-sinir-kaydet" 
                                            data-urun-kodu="{{ product.urun_kodu }}" 
                                            data-renk="{{ product.renk or '' }}" 
                                            data-konum="{{ product.konum }}" 
                                            title="Sınırı Kaydet">
                                        <i class="bi bi-check"></i>
                                    </button>
                                </div>
                            </td>
                            <td>
                                {% if product.is_critical %}
                                    <span class="badge bg-danger">
                                        <i class="bi bi-exclamation-triangle"></i> KRİTİK
                                    </span>
                                {% else %}
                                    <span class="badge bg-success">
                                        <i class="bi bi-check-circle"></i> NORMAL
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-info" 
                                            onclick="showProductHistory('{{ product.urun_kodu }}', '{% if product.renk %}{{ product.renk }}{% endif %}', '{{ product.konum }}')"
                                            title="Stok Geçmişi">
                                        <i class="bi bi-clock-history"></i>
                                    </button>
                                    <a href="{{ url_for('main.stock_list', search=product.urun_kodu) }}" 
                                       class="btn btn-outline-primary" title="Stok Listesinde Göster">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Sayfalama -->
            {% if total > per_page %}
            <div class="card-footer">
                <nav aria-label="Sayfa navigasyonu">
                    <ul class="pagination pagination-sm justify-content-center mb-0">
                        {% if has_prev %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('main.settings_critical_stock', page=prev_num, search=search, location=location, color=color) }}">
                                <i class="bi bi-chevron-left"></i>
                            </a>
                        </li>
                        {% endif %}
                        
                        {% set start_page = [1, page - 2]|max %}
                        {% set end_page = [start_page + 4, (total // per_page) + 1]|min %}
                        
                        {% for page_num in range(start_page, end_page + 1) %}
                        <li class="page-item {% if page_num == page %}active{% endif %}">
                            <a class="page-link" href="{{ url_for('main.settings_critical_stock', page=page_num, search=search, location=location, color=color) }}">
                                {{ page_num }}
                            </a>
                        </li>
                        {% endfor %}
                        
                        {% if has_next %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('main.settings_critical_stock', page=next_num, search=search, location=location, color=color) }}">
                                <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
            {% endif %}
            {% else %}
            <div class="text-center py-4">
                <i class="bi bi-inbox display-1 text-muted"></i>
                <h4 class="mt-3">Ürün Bulunamadı</h4>
                <p class="text-muted">Arama kriterlerinize uygun ürün bulunamadı.</p>
                <a href="{{ url_for('main.settings_critical_stock') }}" class="btn btn-primary">
                    <i class="bi bi-arrow-clockwise"></i> Filtreleri Temizle
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Toplu Sınır Belirleme Modal -->
<div class="modal fade" id="bulkThresholdModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-gear"></i> Toplu Kritik Sınır Belirleme
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="bulkThresholdForm">
                    <div class="mb-3">
                        <label for="bulkThreshold" class="form-label">Yeni Kritik Sınır</label>
                        <input type="number" class="form-control" id="bulkThreshold" 
                               min="0" max="999" value="5" required>
                        <div class="form-text">Bu sınır, mevcut filtrelere uygun tüm ürünlere uygulanacaktır.</div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="confirmBulk" required>
                            <label class="form-check-label" for="confirmBulk">
                                Bu işlemi onaylıyorum
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-warning" onclick="applyBulkThreshold()">
                    <i class="bi bi-check-circle"></i> Uygula
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Otomatik filtreleme için form gönderimi
document.addEventListener('DOMContentLoaded', function() {
    const filterForm = document.getElementById('filterForm');
    const searchInput = document.getElementById('search');
    const locationSelect = document.getElementById('location');
    const colorSelect = document.getElementById('color');
    
    // Arama kutusunda 500ms sonra otomatik filtreleme
    let searchTimeout;
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(function() {
            filterForm.submit();
        }, 500);
    });
    
    // Konum seçildiğinde otomatik filtreleme
    locationSelect.addEventListener('change', function() {
        filterForm.submit();
    });
    
    // Renk seçildiğinde otomatik filtreleme
    colorSelect.addEventListener('change', function() {
        filterForm.submit();
    });
});

// Kritik sınır kaydetme işlemi
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('kritik-sinir-kaydet') || e.target.closest('.kritik-sinir-kaydet')) {
        const button = e.target.classList.contains('kritik-sinir-kaydet') ? e.target : e.target.closest('.kritik-sinir-kaydet');
        const urunKodu = button.getAttribute('data-urun-kodu');
        const renk = button.getAttribute('data-renk');
        const konum = button.getAttribute('data-konum');
        saveCriticalThreshold(urunKodu, renk, konum, button);
    }
});

// Enter tuşu ile kritik sınır kaydet
document.addEventListener('keypress', function(e) {
    if (e.target.classList.contains('kritik-sinir-input') && e.key === 'Enter') {
        const input = e.target;
        const urunKodu = input.getAttribute('data-urun-kodu');
        const renk = input.getAttribute('data-renk');
        const konum = input.getAttribute('data-konum');
        const saveButton = input.nextElementSibling;
        saveCriticalThreshold(urunKodu, renk, konum, saveButton);
    }
});

// Kritik sınırı kaydet
function saveCriticalThreshold(urunKodu, renk, konum, button) {
    const input = button.previousElementSibling;
    const kritikSinir = parseInt(input.value) || 5;
    
    // Minimum değer kontrolü
    if (kritikSinir < 0) {
        alert('Kritik sınır 0\'dan küçük olamaz!');
        input.focus();
        return;
    }
    
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="spinner-border spinner-border-sm"></i>';
    button.disabled = true;
    
    fetch('/api/save-critical-threshold', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            urun_kodu: urunKodu,
            renk: renk,
            konum: konum,
            kritik_sinir: kritikSinir
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Başarı animasyonu
            button.classList.remove('btn-outline-success');
            button.classList.add('btn-success');
            button.innerHTML = '<i class="bi bi-check"></i>';
            
            // Satır rengini güncelle
            const row = button.closest('tr');
            const currentStock = parseInt(row.querySelector('td:nth-child(5) .badge').textContent);
            if (currentStock <= kritikSinir) {
                row.classList.add('table-warning');
                row.querySelector('td:nth-child(7)').innerHTML = '<span class="badge bg-danger"><i class="bi bi-exclamation-triangle"></i> KRİTİK</span>';
            } else {
                row.classList.remove('table-warning');
                row.querySelector('td:nth-child(7)').innerHTML = '<span class="badge bg-success"><i class="bi bi-check-circle"></i> NORMAL</span>';
            }
            
            // Kullanıcıya bilgi ver
            if (data.message) {
                console.log('Kritik stok sınırı güncelleme: ' + data.message);
            }
            
            setTimeout(() => {
                button.classList.remove('btn-success');
                button.classList.add('btn-outline-success');
                button.innerHTML = originalText;
                button.disabled = false;
            }, 1500);
        } else {
            alert('Hata: ' + data.message);
            button.innerHTML = originalText;
            button.disabled = false;
        }
    })
    .catch(error => {
        console.error('Kritik sınır kaydetme hatası:', error);
        alert('Kritik sınır kaydedilirken hata oluştu!');
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

// Toplu sınır belirleme modal
function setBulkThreshold() {
    const modal = new bootstrap.Modal(document.getElementById('bulkThresholdModal'));
    modal.show();
}

// Toplu sınır uygulama
function applyBulkThreshold() {
    const threshold = document.getElementById('bulkThreshold').value;
    const confirmed = document.getElementById('confirmBulk').checked;
    
    if (!confirmed) {
        alert('Lütfen işlemi onaylayın!');
        return;
    }
    
    if (!threshold || parseInt(threshold) < 0) {
        alert('Geçerli bir kritik sınır girin!');
        return;
    }
    
    if (!confirm(`Tüm görüntülenen ürünler için kritik sınır ${threshold} olarak ayarlanacak. Onaylıyor musunuz?`)) {
        return;
    }
    
    // Tüm kritik sınır inputlarını güncelle ve kaydet
    const inputs = document.querySelectorAll('.kritik-sinir-input');
    let completed = 0;
    const total = inputs.length;
    
    if (total === 0) {
        alert('Güncellenecek ürün bulunamadı!');
        return;
    }
    
    inputs.forEach(input => {
        input.value = threshold;
        const button = input.nextElementSibling;
        const urunKodu = input.getAttribute('data-urun-kodu');
        const renk = input.getAttribute('data-renk');
        const konum = input.getAttribute('data-konum');
        
        // Kısa bir gecikme ile sırayla kaydet (sunucuyu yormamak için)
        setTimeout(() => {
            saveCriticalThreshold(urunKodu, renk, konum, button);
            completed++;
            
            if (completed === total) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('bulkThresholdModal'));
                modal.hide();
                setTimeout(() => {
                    alert(`${total} ürün için kritik sınır başarıyla güncellendi!`);
                }, 1000);
            }
        }, completed * 100); // 100ms aralıklarla
    });
}

// Ürün geçmişi gösterme (placeholder)
function showProductHistory(urunKodu, renk, konum) {
    alert(`${urunKodu} ürünü için stok geçmişi özelliği yakında gelecek!`);
}
</script>
{% endblock %}